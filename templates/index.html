<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Pencegahan Stunting</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      /* Tetap gunakan style yang sama agar konsisten */
      :root {
        --primary: #006a4e;
        --sidebar-width: 280px;
      }
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: #f1f5f9;
        overflow-x: hidden;
      }
      .sidebar {
        width: var(--sidebar-width);
        height: 100vh;
        position: fixed;
        background: var(--primary);
        color: white;
        padding: 20px;
        z-index: 1000;
      }
      .main-content {
        margin-left: var(--sidebar-width);
        padding: 30px;
      }
      .stat-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
      }
      .app-section {
        display: none;
        animation: fadeIn 0.3s;
      }
      .app-section.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Chatbot & Markdown */
      .markdown-body p {
        margin-bottom: 5px;
      }
      .markdown-body ul {
        padding-left: 20px;
      }
      .chat-widget {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 2000;
      }
      .chat-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 15px;
        display: none;
        flex-direction: column;
        border: 1px solid #ddd;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f8fafc;
      }
      .msg {
        padding: 8px 12px;
        border-radius: 10px;
        margin-bottom: 8px;
        max-width: 80%;
        font-size: 0.9rem;
      }
      .msg-user {
        background: var(--primary);
        color: white;
        align-self: flex-end;
        margin-left: auto;
      }
      .msg-bot {
        background: white;
        border: 1px solid #ddd;
        align-self: flex-start;
      }
      .chat-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 10px;
        cursor: pointer;
        text-decoration: none;
        display: block;
        margin-bottom: 5px;
        border-radius: 8px;
      }
      .nav-link:hover,
      .nav-link.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: bold;
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 0;
          padding: 0;
        }
        .main-content {
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h4 class="mb-4"><i class="fas fa-seedling"></i> Sahabat Gizi</h4>
      <nav>
        <div class="nav-link active" onclick="switchTab('dashboard')">
          <i class="fas fa-home w-25"></i> Dashboard
        </div>
        <div class="nav-link" onclick="switchTab('checkup')">
          <i class="fas fa-stethoscope w-25"></i> Cek Stunting
        </div>
        <div class="nav-link" onclick="switchTab('mealplan')">
          <i class="fas fa-utensils w-25"></i> Menu MPASI
        </div>
        <div class="nav-link" onclick="switchTab('history')">
          <i class="fas fa-history w-25"></i> Riwayat
        </div>
      </nav>
    </div>

    <div class="main-content">
      <div id="dashboard" class="app-section active">
        <h2 class="fw-bold mb-4">Dashboard Monitoring</h2>
        <div class="row">
          <div class="col-md-4">
            <div class="stat-card bg-primary text-white border-0">
              <h5>Status Terakhir</h5>
              <h2 class="fw-bold" id="dash-status">-</h2>
              <small id="dash-date">Belum ada data</small>
            </div>
          </div>
          <div class="col-md-8">
            <div class="stat-card">
              <h5>Grafik Pertumbuhan</h5>
              <canvas id="growthChart" height="100"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div id="checkup" class="app-section">
        <h2 class="fw-bold mb-4">Cek Kesehatan Anak</h2>
        <div class="row">
          <div class="col-md-5">
            <div class="stat-card">
              <form id="growth-form">
                <div class="mb-3">
                  <label class="fw-bold">Nama Lengkap Anak</label>
                  <input
                    type="text"
                    class="form-control"
                    id="input-name"
                    required
                  />
                </div>
                <div class="row">
                  <div class="col-6 mb-3">
                    <label>Usia (Bulan)</label>
                    <input
                      type="number"
                      class="form-control"
                      id="input-age"
                      required
                    />
                  </div>
                  <div class="col-6 mb-3">
                    <label>Gender</label>
                    <select class="form-select" id="input-gender">
                      <option value="Laki-laki">Laki-laki</option>
                      <option value="Perempuan">Perempuan</option>
                    </select>
                  </div>
                </div>
                <div class="mb-3">
                  <label>Berat (kg)</label>
                  <input
                    type="number"
                    step="0.1"
                    class="form-control"
                    id="input-weight"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label>Tinggi/Panjang (cm)</label>
                  <input
                    type="number"
                    step="0.1"
                    class="form-control"
                    id="input-height"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">
                  Analisis Sekarang
                </button>
              </form>
            </div>
          </div>
          <div class="col-md-7">
            <div class="stat-card" id="result-card" style="display: none">
              <h4 class="text-primary fw-bold" id="res-name-display"></h4>
              <h3 id="res-status" class="mb-3"></h3>
              <div
                id="res-advice"
                class="border p-3 rounded bg-light markdown-body"
              ></div>
              <button
                class="btn btn-success mt-3"
                onclick="switchTab('mealplan')"
              >
                Buat Menu Makanan
              </button>
            </div>
            <div id="loading-checkup" class="text-center py-5 d-none">
              <div class="spinner-border text-primary"></div>
              <p>Sedang Menganalisis...</p>
            </div>
          </div>
        </div>
      </div>

      <div id="mealplan" class="app-section">
        <h2>Generator Menu MPASI</h2>
        <div class="stat-card">
          <button id="btn-gen-menu" class="btn btn-primary mb-3">
            Buat Menu Baru
          </button>
          <div id="menu-result" class="markdown-body bg-light p-3 rounded">
            Belum ada menu.
          </div>
        </div>
      </div>

      <div id="history" class="app-section">
        <div class="d-flex justify-content-between mb-3">
          <h2>Riwayat Pemeriksaan</h2>
          <button
            class="btn btn-outline-primary btn-sm"
            onclick="loadHistoryData()"
          >
            Refresh
          </button>
        </div>
        <div class="stat-card">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Tanggal</th>
                  <th>Nama</th>
                  <th>Usia</th>
                  <th>BB / TB</th>
                  <th>Status</th>
                  <th class="text-end">Aksi</th>
                </tr>
              </thead>
              <tbody id="history-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-widget">
      <div class="chat-window" id="chat-interface">
        <div class="bg-primary text-white p-3 d-flex justify-content-between">
          <span>Konsultan AI</span>
          <button class="btn btn-sm text-white" onclick="toggleChat()">
            X
          </button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="p-3 border-top bg-white">
          <form id="chat-form" class="d-flex gap-2">
            <input
              type="text"
              id="chat-input"
              class="form-control"
              placeholder="Tanya..."
              required
            />
            <button class="btn btn-primary">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </div>
      </div>
      <button class="chat-btn" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
      </button>
    </div>

    <div class="modal fade" id="editNameModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Nama Anak</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-id" />
            <label class="form-label">Nama Baru</label>
            <input type="text" class="form-control" id="edit-name-input" />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveNameUpdate()"
            >
              Simpan Perubahan
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      let currentChild = null;
      // Chart Init
      const ctx = document.getElementById("growthChart").getContext("2d");
      const growthChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: ["Lahir"],
          datasets: [
            {
              label: "Berat (kg)",
              data: [3],
              borderColor: "#006A4E",
              tension: 0.4,
            },
          ],
        },
      });

      function switchTab(id) {
        document
          .querySelectorAll(".app-section")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        document
          .querySelectorAll(".nav-link")
          .forEach((el) => el.classList.remove("active"));
        // Highlight active nav logic can be simpler but this works
        if (id === "history") loadHistoryData();
      }

      // --- CEK STUNTING ---
      document
        .getElementById("growth-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          document.getElementById("loading-checkup").classList.remove("d-none");
          document.getElementById("result-card").style.display = "none";

          const data = {
            nama: document.getElementById("input-name").value,
            usia_bulan: parseInt(document.getElementById("input-age").value),
            gender: document.getElementById("input-gender").value,
            berat_kg: parseFloat(document.getElementById("input-weight").value),
            panjang_cm: parseFloat(
              document.getElementById("input-height").value
            ),
          };

          try {
            const res = await fetch("/api/analyze_growth", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ child_data: data }),
            });
            const result = await res.json();
            currentChild = result.child_data;

            // Render UI
            document.getElementById("loading-checkup").classList.add("d-none");
            document.getElementById("result-card").style.display = "block";
            document.getElementById("res-name-display").textContent =
              result.child_data.nama;

            const statusEl = document.getElementById("res-status");
            statusEl.textContent = result.calculation.status;
            statusEl.className = `fw-bold mb-3 text-${result.calculation.color}`;

            document.getElementById("res-advice").innerHTML = marked.parse(
              result.ai_advice
            );

            // Update Dashboard
            document.getElementById("dash-status").textContent =
              result.calculation.status;
            document.getElementById("dash-date").textContent =
              new Date().toLocaleDateString();
            growthChart.data.labels.push(`Bulan ${data.usia_bulan}`);
            growthChart.data.datasets[0].data.push(data.berat_kg);
            growthChart.update();
          } catch (err) {
            alert("Error: " + err);
            document.getElementById("loading-checkup").classList.add("d-none");
          }
        });

      // --- HISTORY & EDIT NAMA ---
      async function loadHistoryData() {
        const tbody = document.getElementById("history-table-body");
        tbody.innerHTML =
          '<tr><td colspan="6" class="text-center">Loading...</td></tr>';
        try {
          const res = await fetch("/api/history");
          const data = await res.json();
          tbody.innerHTML = "";
          if (!data.length) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="text-center">Kosong</td></tr>';
            return;
          }

          data.forEach((item) => {
            const statusClass = item.status_result.includes("Normal")
              ? "success"
              : item.status_result.includes("Risiko")
              ? "warning"
              : "danger";
            tbody.innerHTML += `
                        <tr>
                            <td>${new Date(
                              item.created_at
                            ).toLocaleDateString()}</td>
                            <td class="fw-bold">${item.nama_anak}</td>
                            <td>${item.usia_bulan} bln</td>
                            <td>${item.berat_kg}kg / ${item.panjang_cm}cm</td>
                            <td><span class="badge bg-${statusClass}">${
              item.status_result
            }</span></td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-warning" onclick="openEditModal('${
                                  item._id
                                }', '${
              item.nama_anak
            }')"><i class="fas fa-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteHistory('${
                                  item._id
                                }')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
          });
        } catch (e) {
          tbody.innerHTML = "Error loading data";
        }
      }

      async function deleteHistory(id) {
        if (confirm("Hapus data ini?")) {
          await fetch(`/api/history/${id}`, { method: "DELETE" });
          loadHistoryData();
        }
      }

      // --- LOGIKA MODAL EDIT (PENGGANTI PROMPT) ---
      let modalInstance;
      function openEditModal(id, currentName) {
        document.getElementById("edit-id").value = id;
        document.getElementById("edit-name-input").value = currentName;

        // Tampilkan Modal Bootstrap
        const modalEl = document.getElementById("editNameModal");
        modalInstance = new bootstrap.Modal(modalEl);
        modalInstance.show();
      }

      async function saveNameUpdate() {
        const id = document.getElementById("edit-id").value;
        const newName = document.getElementById("edit-name-input").value;

        if (!newName) return alert("Nama tidak boleh kosong");

        try {
          await fetch("/api/history/update_name", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: id, new_name: newName }),
          });
          // Tutup Modal & Refresh Table
          modalInstance.hide();
          loadHistoryData();
        } catch (e) {
          alert("Gagal update nama");
        }
      }

      // --- MEAL PLAN & CHAT ---
      document
        .getElementById("btn-gen-menu")
        .addEventListener("click", async () => {
          if (!currentChild) return alert("Cek kesehatan dulu!");
          document.getElementById("menu-result").textContent =
            "Sedang membuat menu...";
          const res = await fetch("/api/generate_meal_plan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ child_data: currentChild }),
          });
          const d = await res.json();
          document.getElementById("menu-result").innerHTML = marked.parse(
            d.response
          );
        });

      function toggleChat() {
        const el = document.getElementById("chat-interface");
        el.style.display = el.style.display === "flex" ? "none" : "flex";
      }

      document
        .getElementById("chat-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const inp = document.getElementById("chat-input");
          const txt = inp.value;
          if (!txt) return;

          // Add User Msg
          const chatBox = document.getElementById("chat-messages");
          chatBox.innerHTML += `<div class="msg msg-user">${txt}</div>`;
          inp.value = "";

          // API Call
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: txt }),
          });
          const d = await res.json();
          chatBox.innerHTML += `<div class="msg msg-bot markdown-body">${marked.parse(
            d.response
          )}</div>`;
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    </script>
  </body>
</html>
