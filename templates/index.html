<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-R" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cegah Stunting - Info & Chatbot Kesehatan</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ... (Seluruh blok <style> besar dari respons sebelumnya diletakkan di sini) ... */
      /* Saya hanya akan menambahkan style baru untuk form data */

      :root {
        --primary-green: #006a4e;
        --secondary-green: #4caf50;
        --light-green-bg: #dff0e8;
        --light-gray-bg: #f8f9fa; /* Lebih cerah dari sebelumnya */
        --text-dark: #212529;
        --text-light: #f8f9fa;
        --white-bg: #ffffff;
        --border-color: #dee2e6;
      }
      body {
        background-color: var(--light-gray-bg);
        font-family: "Poppins", sans-serif;
        color: var(--text-dark);
      }
      .navbar {
        background-color: var(--white-bg);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .navbar-brand {
        color: var(--primary-green) !important;
        font-weight: 700;
      }
      .navbar-brand i {
        margin-right: 8px;
        color: var(--secondary-green);
      }
      .hero {
        background-color: var(--white-bg);
        padding: 4rem;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        margin-top: 2rem;
      }
      .text-primary-green {
        color: var(--primary-green);
      }
      .text-secondary-green {
        color: var(--secondary-green);
      }
      .info-card {
        background-color: var(--white-bg);
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
      }
      .info-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 24px rgba(0, 106, 78, 0.1);
      }
      .info-card .card-body {
        padding: 2rem;
      }
      .info-card i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
      }

      /* --- BAGIAN BARU: Data Pasien --- */
      .data-pasien-container {
        background-color: var(--white-bg);
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
      }
      .nav-tabs .nav-link {
        color: var(--primary-green);
        font-weight: 600;
      }
      .nav-tabs .nav-link.active {
        background-color: var(--primary-green);
        color: var(--white-bg);
        border-color: var(--primary-green);
      }
      .form-label {
        font-weight: 600;
      }
      .btn-simpan {
        background-color: var(--secondary-green);
        border-color: var(--secondary-green);
        color: var(--white-bg);
        font-weight: 600;
      }
      .btn-simpan:hover {
        background-color: #3e8e41;
        border-color: #3e8e41;
        color: var(--white-bg);
      }

      /* ... (Sisa CSS Chatbot dari respons sebelumnya ada di sini) ... */
      #chatbot-toggler {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background-color: var(--primary-green);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }
      #chatbot-toggler:hover {
        background-color: #004a38;
      }
      #chatbot-container {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 370px;
        height: 550px;
        background: var(--white-bg);
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 999;
        transform: scale(0);
        transform-origin: bottom right;
        transition: transform 0.3s ease;
      }
      #chatbot-container.show {
        transform: scale(1);
      }
      #chat-header {
        background-color: var(--primary-green);
        color: white;
        padding: 1.25rem;
        text-align: center;
        font-weight: 600;
        font-size: 1.1rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 2;
      }
      #chat-window {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        background-color: #f9f9f9;
      }
      .chat-message {
        max-width: 85%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        margin-bottom: 0.75rem;
        word-wrap: break-word;
        line-height: 1.4;
        white-space: pre-wrap;
      }
      .user-message {
        background-color: var(--primary-green);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
      }
      .bot-message {
        background-color: var(--white-bg);
        color: var(--text-dark);
        align-self: flex-start;
        border: 1px solid #eee;
        border-bottom-left-radius: 5px;
        position: relative;
        padding-left: 3.5rem;
      }
      .bot-message::before {
        content: "\f0f0";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--secondary-green);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
      }
      #chat-window .bot-message:first-child {
        padding-left: 3.5rem;
      }
      #chat-window .bot-message:first-child::before {
        content: "\f0f0";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--secondary-green);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
      }
      .bot-message.loading {
        font-style: italic;
        color: #777;
        padding-left: 1rem;
      }
      .bot-message.loading::before {
        display: none;
      }
      #chat-input-form {
        display: flex;
        border-top: 1px solid var(--border-color);
        padding: 0.75rem;
        background: var(--white-bg);
      }
      #chat-input-form input {
        flex-grow: 1;
        border: none;
        padding: 0.75rem;
        border-radius: 20px;
        background-color: var(--light-gray-bg);
        margin-right: 0.5rem;
      }
      #chat-input-form input:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--primary-green);
      }
      #chat-input-form button {
        border: none;
        background: var(--primary-green);
        color: white;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        flex-shrink: 0;
        transition: background-color 0.3s ease;
      }
      #chat-input-form button:hover {
        background: #004a38;
      }
      .footer {
        background-color: var(--white-bg);
        padding: 2rem 0;
        margin-top: 4rem;
        border-top: 1px solid var(--border-color);
        text-align: center;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-light">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="fas fa-seedling"></i>
          Sahabat Gizi
        </a>
      </div>
    </nav>

    <div class="container my-5">
      <div class="hero text-center">
        <h1 class="display-4 fw-bold text-primary-green">Cegah Stunting</h1>
        <p class="lead col-lg-8 mx-auto">
          Wujudkan Generasi Sehat Bebas Stunting. Temukan informasi lengkap
          mengenai pencegahan, gizi, dan nutrisi untuk buah hati Anda.
        </p>
      </div>
    </div>

    <div class="container py-5">
      <h2 class="text-center mb-5 fw-bold text-primary-green">
        Mengenal & Mencegah Stunting
      </h2>
      <div class="row g-4">
        <div class="col-md-4">
          <div class="card info-card">
            <div class="card-body text-center">
              <i class="fas fa-child text-secondary-green"></i>
              <h5 class="card-title fw-bold mt-3">Apa itu Stunting?</h5>
              <p class="card-text">
                Stunting adalah kondisi gagal tumbuh pada anak balita akibat
                kekurangan gizi kronis.
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card info-card">
            <div class="card-body text-center">
              <i class="fas fa-heartbeat text-danger"></i>
              <h5 class="card-title fw-bold mt-3">Kunci Pencegahan</h5>
              <p class="card-text">
                Fokus pada 1000 Hari Pertama Kehidupan (HPK), penuhi gizi ibu
                hamil, dan berikan ASI eksklusif.
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card info-card">
            <div class="card-body text-center">
              <i class="fas fa-utensils text-primary"></i>
              <h5 class="card-title fw-bold mt-3">Gizi Seimbang</h5>
              <p class="card-text">
                Pastikan anak mendapatkan asupan protein hewani, lemak sehat,
                vitamin, dan mineral yang cukup.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container py-5">
      <div class="data-pasien-container">
        <h2 class="text-center mb-4 fw-bold text-primary-green">Data Pasien</h2>
        <p class="text-center text-muted mb-4">
          Isi data di bawah ini agar Sahabat Gizi dapat memberi saran yang lebih
          sesuai. Data ini akan disimpan di server kami.
        </p>

        <ul class="nav nav-tabs" id="pasienTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="ibu-tab"
              data-bs-toggle="tab"
              data-bs-target="#ibu-form"
              type="button"
              role="tab"
              aria-controls="ibu-form"
              aria-selected="true"
            >
              Data Ibu Hamil
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="anak-tab"
              data-bs-toggle="tab"
              data-bs-target="#anak-form"
              type="button"
              role="tab"
              aria-controls="anak-form"
              aria-selected="false"
            >
              Data Anak (0-5 Tahun)
            </button>
          </li>
        </ul>

        <div class="tab-content" id="pasienTabContent">
          <div
            class="tab-pane fade show active"
            id="ibu-form"
            role="tabpanel"
            aria-labelledby="ibu-tab"
          >
            <form id="form-data-ibu" class="mt-4">
              <div class="mb-3">
                <label for="ibu-usia-kehamilan" class="form-label"
                  >Usia Kehamilan (minggu)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="ibu-usia-kehamilan"
                  placeholder="Contoh: 30"
                />
              </div>
              <div class="mb-3">
                <label for="ibu-kondisi" class="form-label"
                  >Kondisi Khusus (Opsional)</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="ibu-kondisi"
                  placeholder="Contoh: Anemia, Diabetes Gestasional"
                />
              </div>
            </form>
          </div>

          <div
            class="tab-pane fade"
            id="anak-form"
            role="tabpanel"
            aria-labelledby="anak-tab"
          >
            <form id="form-data-anak" class="mt-4">
              <div class="mb-3">
                <label for="anak-usia" class="form-label"
                  >Usia Anak (bulan)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="anak-usia"
                  placeholder="Contoh: 8"
                />
              </div>
              <div class="mb-3">
                <label for="anak-berat" class="form-label"
                  >Berat Badan (kg)</label
                >
                <input
                  type="number"
                  step="0.1"
                  class="form-control"
                  id="anak-berat"
                  placeholder="Contoh: 7.5"
                />
              </div>
              <div class="mb-3">
                <label for="anak-panjang" class="form-label"
                  >Tinggi/Panjang Badan (cm)</label
                >
                <input
                  type="number"
                  step="0.1"
                  class="form-control"
                  id="anak-panjang"
                  placeholder="Contoh: 68.5"
                />
              </div>
              <div class="mb-3">
                <label for="anak-kondisi" class="form-label"
                  >Kondisi Khusus (Opsional)</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="anak-kondisi"
                  placeholder="Contoh: Alergi susu sapi, GTM"
                />
              </div>
            </form>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
          <button type="button" class="btn btn-simpan" id="save-data-btn">
            <i class="fas fa-save me-2"></i>Simpan Data
          </button>
          <small id="data-status" class="text-muted"
            >Data belum disimpan.</small
          >
        </div>
      </div>
    </div>
    <footer class="footer">
      <p class="mb-0">
        &copy; 2025 Sahabat Gizi. Informasi ini bukan pengganti nasihat medis
        profesional.
      </p>
    </footer>

    <button id="chatbot-toggler">
      <i class="fas fa-comments"></i>
    </button>

    <div id="chatbot-container">
      <div id="chat-header">Sahabat Gizi</div>
      <div id="chat-window">
        <div class="chat-message bot-message">
          Halo! Saya Sahabat Gizi. Silakan isi data pasien di halaman utama agar
          saya bisa memberi saran lebih baik.
        </div>
      </div>
      <form id="chat-input-form">
        <input
          type="text"
          id="user-input"
          placeholder="Ketik pertanyaan Anda..."
          autocomplete="off"
          required
        />
        <button type="submit"><i class="fas fa-paper-plane"></i></button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // === Variabel Global untuk Konteks ===
      let currentUserContext = ""; // Ini akan menyimpan data untuk dikirim ke chat

      // === Seleksi Elemen DOM ===
      const chatbotToggler = document.getElementById("chatbot-toggler");
      const chatbotContainer = document.getElementById("chatbot-container");
      const chatForm = document.getElementById("chat-input-form");
      const userInput = document.getElementById("user-input");
      const chatWindow = document.getElementById("chat-window");

      // --- Elemen Baru ---
      const saveDataBtn = document.getElementById("save-data-btn");
      const dataStatus = document.getElementById("data-status");
      // Form Ibu
      const ibuUsia = document.getElementById("ibu-usia-kehamilan");
      const ibuKondisi = document.getElementById("ibu-kondisi");
      // Form Anak
      const anakUsia = document.getElementById("anak-usia");
      const anakBerat = document.getElementById("anak-berat");
      const anakPanjang = document.getElementById("anak-panjang");
      const anakKondisi = document.getElementById("anak-kondisi");

      // === Logika Chatbot (Sama) ===
      chatbotToggler.addEventListener("click", () => {
        chatbotContainer.classList.toggle("show");
      });

      function appendMessage(sender, message) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("chat-message", `${sender}-message`);
        messageDiv.textContent = message;
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function showLoadingIndicator() {
        const loadingDiv = document.createElement("div");
        loadingDiv.classList.add("chat-message", "bot-message", "loading");
        loadingDiv.textContent = "Sahabat Gizi sedang mengetik...";
        loadingDiv.id = "loading-indicator";
        chatWindow.appendChild(loadingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function removeLoadingIndicator() {
        const loadingDiv = document.getElementById("loading-indicator");
        if (loadingDiv) {
          loadingDiv.remove();
        }
      }

      // === (DIMODIFIKASI) Kirim pesan saat form disubmit ===
      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        appendMessage("user", message);
        userInput.value = "";
        showLoadingIndicator();

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            // ---- PERUBAHAN DI SINI ----
            // Kirim pesan DAN konteks yang sudah disimpan
            body: JSON.stringify({
              message: message,
              context: currentUserContext,
            }),
            // -------------------------
          });

          removeLoadingIndicator();
          if (!response.ok) {
            throw new Error("Gagal mendapatkan respons dari server.");
          }
          const data = await response.json();
          if (data.response) {
            appendMessage("bot", data.response);
          } else {
            throw new Error("Respons server tidak valid.");
          }
        } catch (error) {
          console.error("Error:", error);
          removeLoadingIndicator();
          appendMessage(
            "bot",
            "Maaf, terjadi kesalahan. Silakan coba lagi nanti."
          );
        }
      });

      // === (BARU) Logika Simpan Data Pasien ===
      saveDataBtn.addEventListener("click", async () => {
        // 1. Kumpulkan data dari form
        const motherData = {
          usia_kehamilan_minggu: ibuUsia.value ? parseInt(ibuUsia.value) : null,
          kondisi_khusus: ibuKondisi.value.trim(),
        };
        const childData = {
          usia_bulan: anakUsia.value ? parseInt(anakUsia.value) : null,
          berat_kg: anakBerat.value ? parseFloat(anakBerat.value) : null,
          panjang_cm: anakPanjang.value ? parseFloat(anakPanjang.value) : null,
          kondisi_khusus: anakKondisi.value.trim(),
        };

        // 2. Format data untuk disimpan di MongoDB
        const dataToSave = {
          mother_data: motherData,
          child_data: childData,
        };

        // 3. Format data untuk konteks chatbot (string)
        let contextString = "";
        if (motherData.usia_kehamilan_minggu) {
          contextString += `Data Ibu: Hamil ${motherData.usia_kehamilan_minggu} minggu. `;
          if (motherData.kondisi_khusus)
            contextString += `Kondisi: ${motherData.kondisi_khusus}. `;
        }
        if (childData.usia_bulan) {
          contextString += `\nData Anak: Usia ${childData.usia_bulan} bulan. `;
          if (childData.berat_kg)
            contextString += `Berat ${childData.berat_kg} kg. `;
          if (childData.panjang_cm)
            contextString += `Panjang ${childData.panjang_cm} cm. `;
          if (childData.kondisi_khusus)
            contextString += `Kondisi: ${childData.kondisi_khusus}.`;
        }

        // Update variabel global
        currentUserContext = contextString.trim();

        // 4. Kirim data ke server (MongoDB)
        dataStatus.textContent = "Menyimpan...";
        dataStatus.classList.remove("text-success", "text-danger");
        dataStatus.classList.add("text-muted");

        try {
          const response = await fetch("/api/save_data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSave),
          });

          if (!response.ok) {
            throw new Error("Gagal menyimpan ke server.");
          }

          const result = await response.json();
          console.log("Data tersimpan di DB, ID: ", result.saved_id);

          // 5. Beri umpan balik ke user
          dataStatus.textContent = "Data berhasil disimpan!";
          dataStatus.classList.remove("text-muted", "text-danger");
          dataStatus.classList.add("text-success");

          // Beri tahu user di chatbot
          appendMessage(
            "bot",
            "Data pasien telah diperbarui. Silakan ajukan pertanyaan Anda."
          );
        } catch (error) {
          console.error("Error saving data:", error);
          dataStatus.textContent = "Error saat menyimpan data.";
          dataStatus.classList.remove("text-muted", "text-success");
          dataStatus.classList.add("text-danger");
        }
      });
    </script>
  </body>
</html>
